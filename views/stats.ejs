<%
const activePath = path || '/stats';
const sortedEvents = (events || []).slice().sort((a, b) => String(a.date).localeCompare(String(b.date)));
const sortedInstruments = (instruments || []).slice().sort((a, b) => {
  const sectionA = a.section ? a.section.name : 'ZZZ';
  const sectionB = b.section ? b.section.name : 'ZZZ';
  if (sectionA === sectionB) return a.name.localeCompare(b.name);
  return sectionA.localeCompare(sectionB);
});
const stats = {};
sortedInstruments.forEach((inst) => { stats[inst.id] = {}; });

sortedEvents.forEach((event) => {
  let defaultStatus = null;
  (event.presences || []).forEach((p) => { if (p.status && p.status.isDefault) defaultStatus = p.status; });
  const presentPresences = defaultStatus ? (event.presences || []).filter((p) => p.statusId === defaultStatus.id) : (event.presences || []);
  presentPresences.forEach((p) => {
    const instrumentId = p.musician.instrument.id;
    stats[instrumentId][event.id] = (stats[instrumentId][event.id] || 0) + 1;
  });
});

const getMusiciansByInstrument = (eventId, instrumentId) => {
  const event = sortedEvents.find((e) => e.id === eventId);
  if (!event) return [];
  let defaultStatus = null;
  (event.presences || []).forEach((p) => { if (p.status && p.status.isDefault) defaultStatus = p.status; });
  const presentPresences = defaultStatus ? (event.presences || []).filter((p) => p.statusId === defaultStatus.id) : (event.presences || []);
  return presentPresences
    .filter((p) => p.musician.instrument.id === instrumentId)
    .map((p) => `${p.musician.firstName} ${p.musician.lastName}`.trim())
    .sort((a, b) => a.localeCompare(b, 'fr'));
};

const getPresentMusicians = (eventId) => {
  const event = sortedEvents.find((e) => e.id === eventId);
  if (!event) return [];
  let defaultStatus = null;
  (event.presences || []).forEach((p) => { if (p.status && p.status.isDefault) defaultStatus = p.status; });
  const presentPresences = defaultStatus ? (event.presences || []).filter((p) => p.statusId === defaultStatus.id) : (event.presences || []);
  return presentPresences
    .map((p) => ({
      name: `${p.musician.firstName} ${p.musician.lastName}`.trim(),
      instrument: p.musician.instrument ? p.musician.instrument.name : '',
    }))
    .sort((a, b) => a.name.localeCompare(b.name, 'fr'));
};

const columnTotals = {};
sortedEvents.forEach((event) => {
  let sum = 0;
  Object.values(stats).forEach((s) => { sum += s[event.id] || 0; });
  columnTotals[event.id] = sum;
});
%>
<%- include('partials/header', { helpers, activePath }) %>

<div class="page">
  <h1 class="page-title">Statistiques par instrument</h1>
  <p class="page-subtitle">Nombre de musiciens prÃ©sents par instrument et par concert</p>

  <% if (!sortedEvents.length) { %>
    <p class="page-subtitle">Aucun concert pour le moment.</p>
  <% } else { %>
    <div class="stats-table-wrapper">
      <table class="stats-table">
        <thead>
          <tr>
            <th class="sticky-col">Instrument</th>
            <% sortedEvents.forEach((event) => { %>
              <th>
                <% const eventModalId = `stats-event-${event.id}`; %>
                <button type="button" class="stats-header-button" data-open-modal="<%= helpers.h(eventModalId) %>" data-stop-propagation>
                  <div class="stats-header">
                    <div class="stats-event-title"><%= helpers.h(event.title) %></div>
                    <div class="stats-event-date"><%= helpers.h(helpers.formatDateFr(event.date, false)) %></div>
                  </div>
                </button>
              </th>
            <% }) %>
          </tr>
        </thead>
        <tbody>
          <% sortedInstruments.forEach((instrument) => { 
               let rowTotal = 0;
               sortedEvents.forEach((event) => { rowTotal += stats[instrument.id][event.id] || 0; });
               if (rowTotal === 0) return;
          %>
            <tr>
              <td class="sticky-col">
                <div class="instrument-name">
                  <span class="color-dot" style="background-color: <%= helpers.h((instrument.section && instrument.section.color) ? instrument.section.color : '#94a3b8') %>"></span>
                  <span class="instrument-text">
                    <%= helpers.h(instrument.name) %>
                    <% if (instrument.section) { %>
                      <span class="section-label">(<%= helpers.h(instrument.section.name) %>)</span>
                    <% } %>
                  </span>
                </div>
              </td>
              <% sortedEvents.forEach((event) => { const count = stats[instrument.id][event.id] || 0; const modalId = `stats-${instrument.id}-${event.id}`; %>
                <td class="stats-cell">
                  <% if (count > 0) { %>
                    <button type="button" class="stats-cell-button" data-open-modal="<%= helpers.h(modalId) %>" data-stop-propagation><%= count %></button>
                  <% } else { %>
                    -
                  <% } %>
                </td>
              <% }) %>
            </tr>
          <% }) %>
        </tbody>
        <tfoot>
          <tr>
            <td class="sticky-col total-row">Total</td>
            <% sortedEvents.forEach((event) => { %>
              <% const totalModalId = `stats-total-${event.id}`; const total = columnTotals[event.id] || 0; %>
              <td class="total-row">
                <% if (total > 0) { %>
                  <button type="button" class="stats-cell-button" data-open-modal="<%= helpers.h(totalModalId) %>" data-stop-propagation><%= total %></button>
                <% } else { %>
                  0
                <% } %>
              </td>
            <% }) %>
          </tr>
        </tfoot>
      </table>
    </div>
  <% } %>
</div>

<% sortedInstruments.forEach((instrument) => { %>
  <% sortedEvents.forEach((event) => { const count = stats[instrument.id][event.id] || 0; if (count === 0) return; const modalId = `stats-${instrument.id}-${event.id}`; const names = getMusiciansByInstrument(event.id, instrument.id); %>
    <div class="modal-backdrop is-hidden" data-modal="<%= helpers.h(modalId) %>">
      <div class="modal">
        <div class="modal-header">
          <h2><%= helpers.h(instrument.name) %> Â· <%= count %></h2>
          <button class="icon-button" data-close-modal="<%= helpers.h(modalId) %>" aria-label="Fermer">Ã—</button>
        </div>
        <div class="modal-body">
          <p class="muted-text">Musiciens prÃ©sents pour <strong><%= helpers.h(event.title) %></strong></p>
          <ul class="musician-list">
            <% names.forEach((name) => { %>
              <li><%= helpers.h(name) %></li>
            <% }) %>
          </ul>
        </div>
      </div>
    </div>
  <% }) %>
<% }) %>

<% sortedEvents.forEach((event) => { const totalModalId = `stats-total-${event.id}`; const total = columnTotals[event.id] || 0; if (!total) return; const names = getPresentMusicians(event.id); %>
  <div class="modal-backdrop is-hidden" data-modal="<%= helpers.h(totalModalId) %>">
    <div class="modal">
      <div class="modal-header">
        <h2>PrÃ©sents Â· <%= total %></h2>
        <button class="icon-button" data-close-modal="<%= helpers.h(totalModalId) %>" aria-label="Fermer">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="muted-text">Musiciens prÃ©sents pour <strong><%= helpers.h(event.title) %></strong></p>
        <ul class="musician-list">
          <% names.forEach((item) => { %>
            <li><%= helpers.h(item.name) %> <span class="muted-text">Â· <%= helpers.h(item.instrument) %></span></li>
          <% }) %>
        </ul>
      </div>
    </div>
  </div>
<% }) %>

<% sortedEvents.forEach((event) => { const eventModalId = `stats-event-${event.id}`; %>
  <div class="modal-backdrop is-hidden" data-modal="<%= helpers.h(eventModalId) %>">
    <div class="modal">
      <div class="modal-header">
        <h2><%= helpers.h(event.title) %></h2>
        <button class="icon-button" data-close-modal="<%= helpers.h(eventModalId) %>" aria-label="Fermer">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="event-detail-meta">
          <span>ğŸ“… <%= helpers.h(helpers.formatDateFr(event.date)) %></span>
          <% if (event.location) { %><span>ğŸ“ <%= helpers.h(event.location) %></span><% } %>
        </div>
        <% if (event.description) { %>
          <div class="card-description"><%- helpers.markdownToHtml(event.description) %></div>
        <% } %>
        <% if (event.setlist) { %>
          <div class="attendance-header" style="margin-bottom: 0.35rem;"><h3>Playlist</h3></div>
          <div class="card-description"><%- helpers.markdownToHtml(event.setlist) %></div>
        <% } %>
        <% const comments = (event.presences || []).filter((p) => p.comment && String(p.comment).trim()); %>
        <% if (comments.length) { %>
          <div class="comments-section">
            <h4>Commentaires</h4>
            <ul class="comments-list">
              <% comments.forEach((p) => { %>
                <li><strong><%= helpers.h(`${p.musician.firstName} ${p.musician.lastName}`.trim()) %></strong> : <%= helpers.h(p.comment) %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>
      </div>
    </div>
  </div>
<% }) %>

<%- include('partials/footer', { helpers }) %>
