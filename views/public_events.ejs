<%
const eventsList = (events || []).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
const statusesList = statuses || [];
const musiciansList = musicians || [];
let defaultStatus = null;
statusesList.forEach((status) => {
  if (status.isDefault) defaultStatus = status;
});
const normalizeStatusLabel = (label) => (label || '').toLowerCase().replace('√©', 'e').replace('√®', 'e').replace('√™', 'e').replace('√¢', 'a').replace('√†', 'a').replace('√Æ', 'i').replace('√Ø', 'i').replace('√¥', 'o').replace('√∂', 'o').replace('√ª', 'u').replace('√π', 'u').replace('√ß', 'c');
const uniqueStatusesMap = new Map();
statusesList.forEach((status) => {
  const key = normalizeStatusLabel(status.label);
  if (!uniqueStatusesMap.has(key) || status.isDefault) uniqueStatusesMap.set(key, status);
});
const uniqueStatuses = Array.from(uniqueStatusesMap.values());
const formatEventDate = (iso) => helpers.formatDateFr(iso);
const computeParticipationData = (event, defaultStatus) => {
  const counts = new Map();
  const defaultId = defaultStatus ? defaultStatus.id : null;
  const presences = event.presences || [];
  const presentPresences = defaultId ? presences.filter((p) => p.statusId === defaultId) : presences;
  if (!presentPresences.length) return [];
  presentPresences.forEach((p) => {
    const instrument = p.musician.instrument;
    if (!counts.has(instrument.id)) counts.set(instrument.id, { name: instrument.name, value: 0, color: instrument.color });
    counts.get(instrument.id).value += 1;
  });
  return Array.from(counts.values());
};
const computeMissingData = (event, defaultStatus) => {
  const counts = new Map();
  const defaultId = defaultStatus ? defaultStatus.id : null;
  const presences = event.presences || [];
  const assignments = event.assignments || [];
  const presentIds = new Set();
  presences.forEach((p) => {
    if (!defaultId || p.statusId === defaultId) presentIds.add(p.musicianId);
  });
  assignments.forEach((a) => {
    if (presentIds.has(a.musicianId)) return;
    const instrument = a.musician.instrument;
    if (!counts.has(instrument.id)) counts.set(instrument.id, { name: instrument.name, value: 0, color: instrument.color });
    counts.get(instrument.id).value += 1;
  });
  return Array.from(counts.values());
};
const activePath = path || '/';
%>
<%- include('partials/header', { helpers, activePath }) %>

<div class="page">
  <h1 class="page-title" data-presences-title>Pr√©sences aux concerts</h1>
  <div class="form-field" style="max-width: 360px; margin: 0.5rem 0 1rem;">
    <span>Qui √™tes-vous ?</span>
    <select id="who-are-you" data-who-are-you>
      <option value="">Choisir‚Ä¶</option>
      <% musiciansList.forEach((musician) => { %>
        <option value="<%= musician.id %>" data-first-name="<%= helpers.h(musician.firstName) %>" data-last-name="<%= helpers.h(musician.lastName) %>">
          <%= helpers.h(musician.firstName + ' ' + musician.lastName) %>
        </option>
      <% }) %>
    </select>
  </div>
  <p class="page-subtitle">
    Consultez les concerts √† venir, confirmez votre pr√©sence et visualisez la participation par instrument.
  </p>

  <% if (!eventsList.length) { %>
    <p>Aucun √©v√©nement pour le moment. Revenez bient√¥t !</p>
  <% } else { %>
    <div class="cards-grid">
      <% eventsList.forEach((event) => { %>
        <%
          const assignments = event.assignments || [];
          const presences = event.presences || [];
          const totalAssignments = assignments.length;
          const totalResponses = presences.length;
          const participationRate = totalAssignments > 0 ? Math.round((totalResponses / totalAssignments) * 100) : 0;
          const participationData = computeParticipationData(event, defaultStatus);
          const missingData = computeMissingData(event, defaultStatus);
          const detailModalId = `event-detail-${event.id}`;
          let presentPresences = [];
          if (defaultStatus) {
            presentPresences = presences.filter((p) => p.statusId === defaultStatus.id);
          } else {
            presentPresences = presences;
          }
          const respondedIds = Array.from(new Set(presences.map((p) => p.musicianId)));
          const responseMap = {};
          presences.forEach((p) => {
            responseMap[p.musicianId] = { statusId: p.statusId, comment: p.comment || '' };
          });
          const responseMapAttr = encodeURIComponent(JSON.stringify(responseMap));
          const respondedAttr = respondedIds.join(',');
        %>
        <article class="card clickable" data-open-modal="<%= detailModalId %>">
          <header class="card-header">
            <div class="card-header-content">
              <h2><%= helpers.h(event.title) %></h2>
              <p class="card-date"><%= helpers.h(formatEventDate(event.date)) %></p>
              <% if (event.location) { %>
                <p class="card-location">üìç <%= helpers.h(event.location) %></p>
              <% } %>
              <div class="card-meta">
                <% const statusLabel = event.eventStatus || event.event_status || 'prise de contact'; %>
                <% const statusKey = String(statusLabel).toLowerCase(); %>
                <% const statusClass = (
                  statusKey === 'prise de contact' ? 'status-contact' :
                  statusKey === 'devis envoy√©' ? 'status-quote' :
                  statusKey === 'en cours de recrutement fanfarons' ? 'status-recruit' :
                  statusKey === 'valid√©' ? 'status-valid' :
                  statusKey === 'annul√©' ? 'status-canceled' :
                  statusKey === 'factur√©' ? 'status-billed' : 'status-neutral'
                ); %>
                <span class="stat-badge status-badge <%= statusClass %>"><%= helpers.h(statusLabel) %></span>
                <span class="stat-badge">Pr√©sents: <%= presentPresences.length %></span>
                <span class="stat-badge">R√©ponses: <%= totalResponses %></span>
                <span class="stat-badge participation-rate"><%= participationRate %>%</span>
              </div>
            </div>
            <button
              type="button"
              class="primary-button"
              data-open-modal="presence"
              data-event-id="<%= event.id %>"
              data-event-title="<%= helpers.h(event.title) %>"
              data-responded-ids="<%= helpers.h(respondedAttr) %>"
              data-response-map="<%= helpers.h(responseMapAttr) %>"
              data-default-label="R√©pondre"
              data-stop-propagation
            >
              R√©pondre
            </button>
          </header>
          <% if (event.description) { %>
            <div class="card-description"><%- helpers.markdownToHtml(event.description) %></div>
          <% } %>
        </article>

        <div class="modal-backdrop is-hidden" data-modal="<%= detailModalId %>">
          <div class="modal">
            <div class="modal-header">
              <h2><%= helpers.h(event.title) %></h2>
              <button class="icon-button" data-close-modal="<%= detailModalId %>" aria-label="Fermer">√ó</button>
            </div>
            <div class="modal-body">
              <div class="attendance-list" style="margin-bottom: 1rem;">
                <div class="attendance-header" style="display:flex;align-items:center;justify-content:space-between;">
                  <h3>Infos du concert</h3>
                  <div class="modal-actions" style="display:flex;align-items:center;gap:0.5rem;">
                    <% const detailCommentsHeader = (event.presences || []).filter((p) => p.comment && String(p.comment).trim()); %>
                    <% if (detailCommentsHeader.length) { const commentsModalId = `comments-${event.id}`; %>
                      <button type="button" class="ghost-button small" data-open-modal="<%= helpers.h(commentsModalId) %>" data-stop-propagation>üí¨ Commentaires</button>
                    <% } %>
                    <a class="ghost-button small" href="<%= helpers.baseUrl('/ical/event/' + event.id) %>" title="Exporter">üìÖ Exporter</a>
                  </div>
                </div>
                <div class="attendance-items">
                  <div class="card-meta" style="margin-bottom: 0.75rem;">
                    <% const detailStatusLabel = event.eventStatus || event.event_status || 'prise de contact'; %>
                    <% const detailStatusKey = String(detailStatusLabel).toLowerCase(); %>
                    <% const detailStatusClass = (
                      detailStatusKey === 'prise de contact' ? 'status-contact' :
                      detailStatusKey === 'devis envoy√©' ? 'status-quote' :
                      detailStatusKey === 'en cours de recrutement fanfarons' ? 'status-recruit' :
                      detailStatusKey === 'valid√©' ? 'status-valid' :
                      detailStatusKey === 'annul√©' ? 'status-canceled' :
                      detailStatusKey === 'factur√©' ? 'status-billed' : 'status-neutral'
                    ); %>
                    <span class="stat-badge status-badge <%= detailStatusClass %>"><%= helpers.h(detailStatusLabel) %></span>
                    <span class="stat-badge">üìÖ <%= helpers.h(formatEventDate(event.date)) %></span>
                    <% if (event.location) { %><span class="stat-badge">üìç <%= helpers.h(event.location) %></span><% } %>
                    <% if (event.price) { %><span class="stat-badge">üí∞ <%= helpers.h(event.price) %></span><% } %>
                    <% if (event.organizer) { %><span class="stat-badge">üë§ <%= helpers.h(event.organizer) %></span><% } %>
                  </div>
                  <% if (event.description) { %>
                    <div class="card-description"><%- helpers.markdownToHtml(event.description) %></div>
                  <% } %>
                </div>
              </div>

              <% if (event.setlist) { %>
                <div class="attendance-list setlist-compact" style="margin-top: 0.35rem;">
                  <div class="attendance-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <h3>Playlist</h3>
                    <a class="ghost-button small" href="<%= helpers.baseUrl('/print/setlist/' + event.id) %>" target="_blank" title="Imprimer la playlist">üñ®Ô∏è</a>
                  </div>
                  <div class="attendance-items">
                    <div class="card-description"><%- helpers.markdownToHtml(event.setlist) %></div>
                  </div>
                </div>
              <% } %>

              <div class="charts-container">
                <div class="chart-title">Participation par instrument</div>
                <div class="chart-card">
                  <div class="chart-area">
                    <% if (participationData.length) { %>
                      <div class="chart-canvas-wrapper">
                        <canvas class="chart-canvas" data-chart='<%= JSON.stringify(participationData).replace(/'/g, "&apos;") %>'></canvas>
                      </div>
                    <% } else { %>
                      <p class="chart-empty">Pas d'inscrits.</p>
                    <% } %>
                  </div>
                  <div class="chart-legend" aria-label="L√©gende des instruments"></div>
                </div>
              </div>

              <div class="attendance-list" style="margin-top: 1rem;">
                <div class="attendance-header">
                  <h3>Musiciens pr√©sents</h3>
                  <span class="muted-text"><%= presentPresences.length %> musicien(s)</span>
                </div>
                <div class="attendance-items">
                  <% presentPresences.forEach((presence, index) => { %>
                    <div class="attendance-item <%= index >= 3 ? 'is-hidden' : '' %>" data-expand-group="present-<%= event.id %>">
                      <div class="attendance-info">
                        <span class="attendance-name"><%= helpers.h(presence.musician.firstName + ' ' + presence.musician.lastName) %></span>
                        <span class="attendance-instrument"><%= helpers.h(presence.musician.instrument.name) %></span>
                      </div>
                      <span class="status-chip" style="background: <%= helpers.h(presence.status.color || '#e2e8f0') %>"><%= helpers.h(presence.status.label) %></span>
                    </div>
                  <% }) %>
                </div>
                <div class="form-actions" style="margin-top: 0.75rem;">
                  <button type="button" class="ghost-button" data-expand-button="present-<%= event.id %>" data-expand-open="D√©plier" data-expand-close="Replier">D√©plier</button>
                </div>
              </div>

              <div class="attendance-list" style="margin-top: 1rem;">
                <div class="attendance-header">
                  <h3>Instruments</h3>
                  <span class="muted-text"><%= new Set(presentPresences.map((p) => p.musician.instrument.name)).size %> instrument(s)</span>
                </div>
                <div class="attendance-items">
                  <%
                    const instrumentMap = new Map();
                    presentPresences.forEach((p) => {
                      instrumentMap.set(p.musician.instrument.name, (instrumentMap.get(p.musician.instrument.name) || 0) + 1);
                    });
                    let instrumentIndex = 0;
                  %>
                  <% instrumentMap.forEach((count, instrumentName) => { %>
                    <div class="attendance-item <%= instrumentIndex >= 3 ? 'is-hidden' : '' %>" data-expand-group="instruments-<%= event.id %>">
                      <div class="attendance-info">
                        <span class="attendance-name"><%= helpers.h(instrumentName) %></span>
                        <span class="attendance-instrument"><%= count %> musicien(s)</span>
                      </div>
                    </div>
                    <% instrumentIndex++; %>
                  <% }) %>
                </div>
                <div class="form-actions" style="margin-top: 0.75rem;">
                  <button type="button" class="ghost-button" data-expand-button="instruments-<%= event.id %>" data-expand-open="D√©plier" data-expand-close="Replier">D√©plier</button>
                </div>
              </div>

              <div class="attendance-list" style="margin-top: 1.5rem;">
                <div class="attendance-header">
                  <h3>Pupitres</h3>
                  <span class="muted-text"><%= new Set(presentPresences.map((p) => p.musician.instrument.section ? p.musician.instrument.section.name : 'Sans pupitre')).size %> pupitre(s)</span>
                </div>
                <div class="attendance-items">
                  <%
                    const sectionsMap = new Map();
                    presentPresences.forEach((p) => {
                      const sectionName = p.musician.instrument.section ? p.musician.instrument.section.name : 'Sans pupitre';
                      sectionsMap.set(sectionName, (sectionsMap.get(sectionName) || 0) + 1);
                    });
                    let sectionIndex = 0;
                  %>
                  <% sectionsMap.forEach((count, sectionName) => { %>
                    <div class="attendance-item <%= sectionIndex >= 3 ? 'is-hidden' : '' %>" data-expand-group="sections-<%= event.id %>">
                      <div class="attendance-info">
                        <span class="attendance-name"><%= helpers.h(sectionName) %></span>
                        <span class="attendance-instrument"><%= count %> musicien(s)</span>
                      </div>
                    </div>
                    <% sectionIndex++; %>
                  <% }) %>
                </div>
                <div class="form-actions" style="margin-top: 0.75rem;">
                  <button type="button" class="ghost-button" data-expand-button="sections-<%= event.id %>" data-expand-open="D√©plier" data-expand-close="Replier">D√©plier</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% const detailComments = (event.presences || []).filter((p) => p.comment && String(p.comment).trim()); %>
        <% if (detailComments.length) { const commentsModalId = `comments-${event.id}`; %>
          <div class="modal-backdrop is-hidden" data-modal="<%= helpers.h(commentsModalId) %>">
            <div class="modal">
              <div class="modal-header">
                <h2>Commentaires</h2>
                <button class="icon-button" data-close-modal="<%= helpers.h(commentsModalId) %>" aria-label="Fermer">√ó</button>
              </div>
              <div class="modal-body">
                <ul class="comments-list">
                  <% detailComments.forEach((p) => { %>
                    <li><strong><%= helpers.h(`${p.musician.firstName} ${p.musician.lastName}`.trim()) %></strong> : <%= helpers.h(p.comment) %></li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        <% } %>
      <% }) %>
    </div>
  <% } %>
</div>

<div class="modal-backdrop is-hidden" data-modal="presence">
  <div class="modal">
    <div class="modal-header">
      <h2 data-modal-title>R√©pondre √† l'√©v√©nement</h2>
      <button class="icon-button" data-close-modal="presence" aria-label="Fermer">√ó</button>
    </div>
    <div class="modal-body">
      <form method="post" action="<%= helpers.baseUrl('/presence') %>" class="form" data-presence-form>
        <input type="hidden" name="event_id" value="" />
        <input type="hidden" name="musician_id" value="" />

        <label class="form-field">
          <span>Musicien assign√©</span>
          <select name="musician_select" data-musician-select>
            <option value="">Choisir un musicien</option>
            <% musiciansList.forEach((musician) => { %>
              <option value="<%= musician.id %>" data-first-name="<%= helpers.h(musician.firstName) %>" data-last-name="<%= helpers.h(musician.lastName) %>"><%= helpers.h(musician.firstName + ' ' + musician.lastName) %></option>
            <% }) %>
          </select>
        </label>

        <div class="form-grid">
          <label class="form-field">
            <span>Pr√©nom</span>
            <input type="text" name="first_name" placeholder="Votre pr√©nom" />
          </label>
          <label class="form-field">
            <span>Nom</span>
            <input type="text" name="last_name" placeholder="Votre nom" />
          </label>
        </div>

        <fieldset class="form-field">
          <legend>Votre r√©ponse</legend>
          <div class="radio-group">
            <% uniqueStatuses.forEach((status) => { %>
              <label class="radio-option">
                <input type="radio" name="status_id" value="<%= status.id %>" required />
                <span class="radio-label">
                  <span class="color-dot" style="background-color: <%= helpers.h(status.color || '#e2e8f0') %>"></span>
                  <%= helpers.h(status.label) %>
                </span>
              </label>
            <% }) %>
          </div>
        </fieldset>

        <label class="form-field">
          <span>Commentaire</span>
          <textarea name="comment" rows="3" placeholder="Message, infos compl√©mentaires..."></textarea>
        </label>

        <div class="form-actions">
          <button type="submit" class="primary-button">Envoyer</button>
          <button type="button" class="ghost-button" data-close-modal="presence">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer', { helpers }) %>
